<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Order Status (Starter)</title>
  <link rel="stylesheet" href="/static/common.css">
  <style>
  /* Hide all modals by default */
  .orders-page [id^="modal-"]{ display:none; }

  /* Keep the centering/layering */
  .orders-page [id^="modal-"]{
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1001;
    background:#fff; border:1px solid var(--border); border-radius:8px;
    width:min(780px,96vw); max-height:90vh; overflow:auto; padding:14px;
    box-shadow:0 12px 32px rgba(0,0,0,.25);
  }

  /* Optional backdrop (if you have #overlay-... elements) */
  .orders-page [id^="overlay-"]{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:1000; }

  /* Inputs & footer inside modal */
  .orders-page [id^="modal-"] input[type="text"],
  .orders-page [id^="modal-"] input[type="date"],
  .orders-page [id^="modal-"] select,
  .orders-page [id^="modal-"] textarea{ width:100%; height:32px; font-size:13px; padding:6px 10px; margin-bottom:6px; }
  .orders-page [id^="modal-"] textarea{ height:80px; }
  .orders-page [id^="modal-"] .footer{ display:flex; justify-content:flex-end; gap:8px; margin-top:8px; }
  .orders-page .modal{ display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  z-index:1001; background:#fff; border:1px solid var(--border); border-radius:8px;
  width:min(780px,96vw); max-height:90vh; overflow:auto; padding:14px; box-shadow:0 12px 32px rgba(0,0,0,.25); }
  .orders-page .modal.open{ display:block; }

  .orders-page .modal-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:1000; }
  .orders-page .modal-overlay.open{ display:block; }

  .orders-page .modal input[type="text"],
  .orders-page .modal input[type="date"],
  .orders-page .modal select,
  .orders-page .modal textarea{ width:100%; height:32px; font-size:13px; padding:6px 10px; margin-bottom:6px; }
  .orders-page .modal textarea{ height:80px; }
  .orders-page .modal .footer{ display:flex; justify-content:flex-end; gap:8px; margin-top:8px; }

  /* Dialog chrome */
  .orders-page .modal{
    display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    z-index:1001; background:#fff; border:1px solid var(--border); border-radius:10px;
    width:min(880px,96vw); max-height:88vh; box-shadow:0 18px 40px rgba(0,0,0,.35);
  }
  .orders-page .modal.open{ display:block; }

  /* Backdrop */
  .orders-page .modal-overlay{
    display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); backdrop-filter: blur(2px);
    z-index:1000;
  }
  .orders-page .modal-overlay.open{ display:block; }

  /* Header/Body/Footer */
  .orders-page .modal .m-header{
    padding:12px 16px; font-weight:700; border-bottom:1px solid var(--border);
  }
  .orders-page .modal .m-body{
    padding:14px 16px; overflow:auto; max-height: calc(88vh - 56px - 56px); /* total - header - footer */
  }
  .orders-page .modal .m-footer{
    padding:10px 16px; border-top:1px solid var(--border); display:flex; gap:8px; justify-content:flex-end;
    position:sticky; bottom:0; background:#fff;
  }

  /* Form grid */
  .orders-page .form-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px 12px; }
  .orders-page .form-grid .full{ grid-column:1 / -1; }
  .orders-page .form-grid input[type="text"],
  .orders-page .form-grid input[type="date"],
  .orders-page .form-grid select,
  .orders-page .form-grid textarea{
    width:100%; height:34px; padding:8px 10px; font-size:13px; border:1px solid #ddd; border-radius:6px;
  }
  .orders-page .form-grid textarea{ height:90px; resize:vertical; }

  /* Keep page from scrolling behind the modal */
  body.modal-open{ overflow:hidden; }
  </style>
  <script defer src="/static/main.js"></script>
</head>
<body class="orders-page">
  <div class="layout">
  <!-- Sidebar: search + future menu -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">Search</div>

    <!-- Search form (GET) -->
    <form method="get" action="{{ '/archived' if archived_page else '/' }}" class="sbm">
      <input type="text" name="q" id= "search-q" value="{{ qtext or '' }}"
             placeholder="搜尋：">

      <select name="dfield">
        <option value="any"        {{ 'selected' if (dfield or 'any')=='any' }}>全部日期欄位</option>
        <option value="demand"     {{ 'selected' if dfield=='demand' }}>客戶交期</option>
        <option value="delivery"   {{ 'selected' if dfield=='delivery' }}>預計出貨</option>
        <option value="datecreate" {{ 'selected' if dfield=='datecreate' }}>派單日</option>
      </select>

      <div class="row">
        <input type="date" name="dfrom" value="{{ dfrom or '' }}">
        <input type="date" name="dto"   value="{{ dto or '' }}">
      </div>

      <div class="row">
        <button class="btn" type="submit">Search</button>
        {% if qtext or dfrom or dto %}
          <a class="btn gray" href="{{ '/archived' if archived_page else '/' }}">Clear</a>
        {% endif %}
      </div>

      <div class="caption">共 {{ orders|length }} 筆{% if qtext or dfrom or dto %}（篩選中）{% endif %}</div>

      <hr style="margin:12px 0">

      <div class="nav" style="margin-top:6px">
        <!-- General stations page -->
        <a href="/stations/today" class="btn full">Stations — Today</a>
        <hr style="margin:12px 0">
        <a href="/stations/backlog" class="btn full gray" style="margin-top:6px">Stations — Backlog</a>


        <!-- Quick link for *today's* plan (uses your today_date; converts 2025/08/20 -> 2025-08-20) -->
        </a>
      </div>
    </form>
  </aside>
  <main class="content">
  <div style="display:flex;align-items:center;gap:12px;">
    <button class="btn hamburger" onclick="toggleSidebar()">☰ Menu</button>
  </div>
  <h1>Live Order Status</h1>
  <!-- Top toolbar -->
  <div class="toolbar">
    <div class="left">
      <a href="/" class="btn {{ '' if archived_page else 'blue' }}">Active</a>
      <a href="/archived" class="btn {{ 'blue' if archived_page else '' }}">Archived</a>
      {% if not archived_page %}
        <button class="btn" onclick="openModal('modal-order')">Add Order</button>
      {% endif %}
    </div>
    <div class="right">
      <button class="btn" onclick="location.href='/export/orders.xlsx'">Export Excel</button>
      <button class="btn gray" onclick="openModal('modal-import')">Import Excel</button>
      <span style="color:#6c757d">Today {{ today_date }}</span>
    </div>
  </div>
  <!-- Content -->
    <table>
      <thead>
        <tr>
          <th>Progress</th>
          <th>客戶交期</th>
          <th>預計出貨</th>
          <th>製令號碼</th>
          <th>專案名稱</th>
          <th>產品名稱</th>
          <th>數量</th>
          <th>派單日</th>
          <th>封邊</th>
          <th>面飾</th>
          <th>作業內容</th>
          <th>現場組別</th>
          <th>Actions</th>
        </tr>
      </thead>
      {% for o in orders %}
      <tr id="order-{{o.id}}"
        data-demand="{{ o.demand_date|e }}"
        data-delivery="{{ o.delivery|e }}"
        data-code="{{ o.manufacture_code|e }}"
        data-customer="{{ o.customer|e }}"
        data-product="{{ o.product|e }}"
        data-qty="{{ o.quantity }}"
        data-datecreate="{{ o.datecreate|e }}"
        data-fengbian="{{ o.fengbian|e }}"
        data-wallpaper="{{ o.wallpaper|e }}"
        data-jobdesc="{{ o.jobdesc|e }}">
        <td>
          {% set done = o.progress[0] %}
          {% set total = o.progress[1] if o.progress[1] else 1 %}
          <div class="progress-bar">
            <div class="progress-fill" style="width: {{ (done/total)*100 }}%"></div>
          </div>
        </td>
        <td>{{ o.demand_date|fmtdate or '—' }}</td>
        <td>{{ o.delivery|fmtdate or '—' }}</td>
        <td>{{ o.manufacture_code }}</td>
        <td>{{ o.customer }}</td>
        <td>{{ o.product }}</td>
        <td>{{ o.quantity }}</td>
        <td>{{ o.datecreate }}</td>
        <td>{{ o.fengbian }}</td>
        <td>{{ o.wallpaper }}</td>
        <td>{{ o.jobdesc }}</td>
        <td id="groups-{{o.id}}">{{ o.assigned_groups or '—' }}</td>
        <td class="actions-col">
          <div class="actions-group">
            {% if archived_page == False %}
              <button class="btn green" onclick="toggleDetails({{o.id}})">Expand</button>
              <button class="btn gray" onclick="openEditOrder({{ o.id }})">Edit</button>
              <button class="btn red" onclick="deleteOrder({{ o.id }})">Delete</button>
              <button class="btn gray" onclick="archiveOrder({{ o.id }})">Archive</button>
            {% else %}
              <button class="btn gray" onclick="restoreOrder({{ o.id }})">Restore</button>
              <button class="btn red" onclick="deleteOrder({{ o.id }})">Delete</button>
            {% endif %}
          </div>
        </td>
      </tr>

      <tr>
        <td colspan="13" style="padding:0; border:0">
          <table style="width:100%; border-collapse:collapse">
            <tbody id="details-{{ o.id }}" style="display:none">
              <tr>
                <th>Progress</th>
                <th>組別</th>
                <th>數量</th>
                <th>工作內容</th>
                <th>已完成</th>
                <th>剩下</th>
                <th>Actions</th>
              </tr>
              {% for t in o.sub_tasks %}
              <tr id="task-{{ t.id }}" data-qty="{{ t.quantity }}" data-order="{{ o.id }}">
                <td>
                  {% set ttot = t.quantity if t.quantity else 1 %}
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ (t.completed / ttot) * 100 }}%"></div>
                  </div>
                  <div class="task-status {{ 'running' if t.running else '' }}">
                    <span class="dot"></span>
                    <span>
                      {{ 'Running' if t.running else 'Idle' }}
                      {% if t.running and t.started_at %}
                        <span style="opacity:.7">• since {{ t.started_at[:19].replace('T',' ') }}</span>
                      {% endif %}
                    </span>
                  </div>
                </td>
                <td>{{ t.group }}</td>
                <td class="qty">{{ t.quantity }}</td>
                <td class="name">{{ t.task }}</td>
                <td>{{ t.quantity }}</td>
                <td>{{ t.task }}</td>
                <td><input type="number" id="done-{{ t.id }}" value="{{ t.completed }}" style="width:80px;text-align:center"></td>
                <td class="remaining">{{ t.remaining }}</td>
                <td class="actions-col">
                  <div class="actions-group">
                    <button type="button" class="btn gray" onclick="startTask({{ t.id }})" {{ 'disabled' if t.running else '' }}>Start</button>
                    <button type="button" class="btn" onclick="updateTask({{ t.id }}, {{ o.id }})">Update</button>
                    <button class="btn" onclick="showHistory({{ t.id }}, {{ o.id }})">History</button>
                    <button class="btn" onclick="editTask({{ t.id }}, {{ o.id }}, '{{ t.group }}', '{{ t.task }}', {{ t.quantity }})">Edit</button>
                    <button class="btn red" onclick="deleteTask({{ t.id }}, {{ o.id }})">Delete</button>
                    <button type="button" class="btn gray" title="Stop the process" onclick="stopTask({{ t.id }})" {{ '' if t.running else 'disabled' }}>Stop</button>
                    <button type="button" class="btn" title="加入該該站的今日計畫" onclick="planFromMain({{ t.id }}, '{{ t.group }}')" {{ 'disabled' if (t.remaining|int) <= 0 else '' }}>+ Plan</button>
                    <span id="planned-flag-{{ t.id }}" class="pill success" style="margin-left:6px; {{ '' if (t.id in planned_today_ids) else 'display:none' }}" >已在今日計畫</span>
                  </div>
                </td>
              </tr>
              {% endfor %}
              <tr>
                <td colspan="7"><button class="btn" onclick="openTaskModal({{ o.id }})">+ Add Task</button></td>
              </tr>
            </tbody>
          </table>
        </td>
      </tr>
      {% if not loop.last %}
      <tr class="order-gap"><td colspan="13" aria-hidden="true"></td></tr>
      {% endif %}
      {% endfor %}
    </table>
  </main>
  </div>

  <!-- Mobile overlay -->
  <div id="overlay-import" class="modal-overlay" onclick="closeModal('modal-import')"></div>
      <!-- Import Modal -->
  <div id="modal-import" class="modal">
    <h3>Import Orders (Excel .xlsx)</h3>
    <div class="footer">
      <button type="button" class="btn red" onclick="closeModal('modal-import')">Close</button>
      <button type="button" class="btn" onclick="uploadImport()">Upload & Import</button>
    </div>
    <input type="file" id="import-file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="margin-top:10px">
    <div style="margin-top:8px">
      <input id="import-sheet" placeholder="工作表名稱 (例如: 生產中門框)" value="生產中門框" />
    </div>
  </div>
  <div id="modal-bulk" class="modal" onclick="if(event.target===this) closeModal('modal-bulk')">
    <div class="panel">
      <h3 style="margin:0">Bulk Add Tasks</h3>
      <input type="hidden" id="bulk-order-id">
      <div class="station-planner" id="bulk-planner"></div>
      <button class="btn gray" onclick="addPlannedStationTo('bulk-planner')">+ 新增站</button>
      <div style="margin-top:12px"><button class="btn" onclick="submitBulkTasks()">Save</button></div>
    </div>
  </div>


  <!-- Backdrop -->
  <div id="overlay-order" class="modal-overlay" onclick="closeModal('modal-order')"></div>

  <!-- Modal -->
  <div id="modal-order" class="modal" role="dialog" aria-modal="true" aria-labelledby="order-title">
    <div class="m-header" id="order-title">Add Order</div>

    <div class="m-body">
      <div class="form-grid">
        <input type="text" name="demand_date"   placeholder="客戶交期 YYYY/MM/DD" autofocus>
        <input type="text" name="delivery"      placeholder="預計出貨 YYYY/MM/DD">
        <input type="text" name="manufacture_code" placeholder="製令號碼">
        <input type="text" name="project"       placeholder="專案名稱">
        <input type="text" name="product"       placeholder="產品名稱">
        <input type="number" name="quantity"    placeholder="數量" min="0" step="1">
        <input type="text" name="datecreate"    placeholder="派單日 YYYY/MM/DD">
        <input type="text" name="fengbian"      placeholder="封邊">
        <input type="text" name="surface"       placeholder="面飾">

        <div class="full">
          <textarea name="note" placeholder="備註"></textarea>
        </div>

        <!-- 計劃流程 -->
        <div class="full">
          <div style="font-weight:600;margin:6px 0 4px">計劃流程（初始站）</div>
          <button type="button" class="btn gray">+ 新增站</button>
        </div>
      </div>
    </div>

    <div class="m-footer">
      <button type="button" class="btn gray" onclick="closeModal('modal-order')">Close</button>
      <button type="button" class="btn" onclick="saveOrder()">Save</button>
    </div>
  </div>

<template id="station-template">
  <div class="row">
    <select class="station-select">
      <option value="">-- 選擇組別 --</option>
      <option value="原物料裁切組">原物料裁切組</option>
      <option value="框架組">框架組</option>
      <option value="膠合組">膠合組</option>
      <option value="門裁切組">門裁切組</option>
      <option value="封邊組">封邊組</option>
      <option value="整修組">整修組</option>
      <option value="噴漆組">噴漆組</option>
      <option value="CNC組">CNC組</option>
      <option value="包裝組">包裝組</option>
      <option value="自動缐組">自動缐組</option>
      <option value="__custom__">自訂組別…</option>
    </select>
    <input type="text" class="custom-station-input" placeholder="輸入自訂組別名稱" style="display:none">
    <input type="text" class="task-name-input" placeholder="工作內容"/>
    <button class="btn red" onclick="this.parentNode.remove()">X</button>
  </div>
</template>

  <div id="modal-edit-order" class="modal" onclick="if(event.target===this) closeModal('modal-edit-order')">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Edit Order</h3>
        <button class="btn" onclick="closeModal('modal-edit-order')">Close</button>
      </div>

      <input type="hidden" id="e-id" />
      <div style="margin-top:10px"><input id="e-demand" placeholder="客戶交期 YYYY/MM/DD"></div>
      <div style="margin-top:8px"><input id="e-delivery" placeholder="預計出貨 YYYY/MM/DD"></div>
      <div style="margin-top:8px"><input id="e-code" placeholder="製令號碼"></div>
      <div style="margin-top:8px"><input id="e-customer" placeholder="專案名稱"></div>
      <div style="margin-top:8px"><input id="e-product" placeholder="產品名稱"></div>
      <div style="margin-top:8px"><input id="e-qty" type="number" placeholder="數量"></div>
      <div style="margin-top:8px"><input id="e-datecreate" placeholder="派單日 YYYY/MM/DD"></div>
      <div style="margin-top:8px"><input id="e-fengbian" placeholder="封邊"></div>
      <div style="margin-top:8px"><input id="e-wallpaper" placeholder="面飾"></div>
      <div style="margin-top:8px"><input id="e-jobdesc" placeholder="作業內容"></div>

      <div style="margin-top:12px"><button class="btn" onclick="submitEditOrder()">Save</button></div>
    </div>
  </div>


  <!-- Add Task Modal -->
  <div id="modal-task" class="modal" onclick="if(event.target===this) closeModal('modal-task')">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Add Task</h3>
        <button class="btn" onclick="closeModal('modal-task')">Close</button>
      </div>
      <input type="hidden" id="t-order-id" />
      <div style="margin-top:10px; display:flex; gap:12px; align-items:center">
        <select id="t-group-select" class="station-select" style="min-width:180px">
          <option value="">-- 選擇組別 --</option>
          <option value="原物料裁切組">原物料裁切組</option>
          <option value="框架組">框架組</option>
          <option value="膠合組">膠合組</option>
          <option value="門裁切組">門裁切組</option>
          <option value="封邊組">封邊組</option>
          <option value="整修組">整修組</option>
          <option value="噴漆組">噴漆組</option>
          <option value="CNC組">CNC組</option>
          <option value="包裝組">包裝組</option>
          <option value="自動缐組">自動缐組</option>
          <option value="__custom__">自訂組別…</option>
        </select>
        <input type="text" id="t-group-custom" class="custom-station-input"
              placeholder="輸入自訂組別名稱" style="display:none; width:160px">
      </div>
      <div style="margin-top:8px"><input id="t-task" placeholder="工作內容"></div>
      <div style="margin-top:8px"><input id="t-qty" type="number" placeholder="數量"></div>
      <div style="margin-top:12px"><button class="btn" onclick="submitTask()">Save</button></div>
    </div>
  </div>

  <!-- Task History Modal -->
  <div id="modal-history" class="modal" onclick="if(event.target===this) closeModal('modal-history')">
  <div class="panel" style="max-height:70vh;overflow:auto">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Task History</h3>
      <button class="btn" onclick="closeModal('modal-history')">Close</button>
    </div>
    <div id="history-content" style="margin-top:12px">
      <p>Loading...</p>
    </div>
  </div>
</div>

  <!-- Edit Task Modal -->
<div id="modal-edit-task" class="modal" onclick="if(event.target===this) closeModal('modal-edit-task')">
  <div class="panel">
    <h3>Edit Task</h3>
    <input type="hidden" id="edit-task-id" />
    <input type="hidden" id="edit-order-id" />
    <div style="margin-top:8px; display:flex; gap:12px; align-items:center">
      <select id="edit-group-select" class="station-select" style="min-width:180px">
        <option value="">-- 選擇組別 --</option>
        <option value="原物料裁切組">原物料裁切組</option>
        <option value="框架組">框架組</option>
        <option value="膠合組">膠合組</option>
        <option value="門裁切組">門裁切組</option>
        <option value="封邊組">封邊組</option>
        <option value="整修組">整修組</option>
        <option value="噴漆組">噴漆組</option>
        <option value="CNC組">CNC組</option>
        <option value="包裝組">包裝組</option>
        <option value="自動缐組">自動缐組</option>
        <option value="__custom__">自訂組別…</option>
      </select>
      <input type="text" id="edit-group-custom" class="custom-station-input"
            placeholder="輸入自訂組別名稱" style="display:none; width:160px">
    </div>
    <div style="margin-top:8px"><input id="edit-name" placeholder="工作內容"></div>
    <div style="margin-top:8px"><input id="edit-qty" type="number" placeholder="數量"></div>
    <div style="margin-top:12px"><button class="btn" onclick="submitEditTask()">Save</button></div>
  </div>
</div>

</body>
</html>
