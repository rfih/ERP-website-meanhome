<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Order Status (Starter)</title>
  <style>
    body{font-family:Arial, sans-serif;background:#ededf0;margin:20px}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:6px;overflow:hidden}
    th,td{border:1px solid #ddd;padding:8px;text-align:center}
    th{background:#007bff;color:#fff}
    .progress-bar{width:100%;height:10px;background:#e0e0e0;border-radius:6px;overflow:hidden}
    .progress-fill{height:100%;background:#28a745;transition:width .3s}
    .btn{padding:10px 12px;border:0;border-radius:4px;color:#fff;background:#007bff;cursor:pointer}
    .btn.green{background:#28a745}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:1000;overflow:auto}
    .panel{width:520px;margin:8% auto;background:#fff;border-radius:8px;padding:8px 10px;overflow:auto}
    input,select{height:auto;padding:10px 0px;font-size: 12px;border:1px solid #ccc;border-radius:4px;width:100%}
    .btn.red { background: #dc3545; }
    .btn.red { background: #dc3545; }
    .btn.gray { background: #6c757d; }
    tr.is-running { outline: 2px solid #ffc107; outline-offset: -2px; }
    #station-planner .row{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:12px;
    }

    /* make the dropdown roomy */
    #station-planner .station-select{
      flex:0 0 220px;     /* fixed, comfortable width */
      min-width:180px;
      height: auto;
    }

    /* let the text input take the rest */
    #station-planner .task-name-input{
      flex:1 1 auto;
    }

    /* keep the delete button compact */
    #station-planner .btn.red{
      flex:0 0 44px;
    }
    #station-planner .custom-station-input{
      flex:0 0 160px;   /* sits between select and task name */
    }
    .task-status{margin-top:6px;display:flex;align-items:center;gap:6px;justify-content:center;font-size:12px;color:#6c757d}
    .task-status .dot{width:8px;height:8px;border-radius:50%;background:#adb5bd}
    .task-status.running{color:#28a745;font-weight:600}
    .task-status.running .dot{background:#28a745;box-shadow:0 0 0 0 rgba(40,167,69,.4);animation:pulse 1.4s infinite}
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(40,167,69,.45)}
      70%{box-shadow:0 0 0 8px rgba(40,167,69,0)}
      100%{box-shadow:0 0 0 0 rgba(40,167,69,0)}
    }
    /* animated stripes when a task is running */
    .progress-fill.running{
      position: relative;
      background-image: linear-gradient(
        45deg,
        rgba(255,255,255,.25) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255,255,255,.25) 50%,
        rgba(255,255,255,.25) 75%,
        transparent 75%,
        transparent
      );
      background-size: 16px 16px;
      animation: prog-stripes 1s linear infinite;
    }
    @keyframes prog-stripes{ from{background-position:0 0} to{background-position:16px 0} }

    /* optional: highlight the running row */
    tr.is-running { outline: 2px solid #ffc107; outline-offset: -2px; }

    .order-gap td{
      height: 14px;
      padding: 0;
      border: 0;
      background: #f5f7fb;          /* subtle bar */
      border-top: 1px solid #e9ecef; /* thin lines for separation */
      border-bottom: 1px solid #e9ecef;
      border-radius: 6px;
    }
  </style>
  <script defer src="/static/main.js"></script>
</head>
<body>
  <h1>Live Order Status</h1>
  <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
    <a href="/" class="btn {{ '' if archived_page else 'blue' }}">Active</a>
    <a href="/archived" class="btn {{ 'blue' if archived_page else '' }}">Archived</a>
      {% if not archived_page %}
        <button class="btn" onclick="openModal('modal-order')">Add Order</button>
        <p>Today {{ today_date }}</p>
      {% endif %}
  </div>

  <table>
    <tr>
      <th>Progress</th>
      <th>客戶交期</th>
      <th>預計出貨</th>
      <th>製令號碼</th>
      <th>專案名稱</th>
      <th>產品名稱</th>
      <th>數量</th>
      <th>派單日</th>
      <th>封邊</th>
      <th>面飾</th>
      <th>作業內容</th>
      <th>現場組別</th>
      <th>Actions</th>
    </tr>
    {% for o in orders %}
    <tr id="order-{{o.id}}"
      data-demand="{{ o.demand_date|e }}"
      data-delivery="{{ o.delivery|e }}"
      data-code="{{ o.manufacture_code|e }}"
      data-customer="{{ o.customer|e }}"
      data-product="{{ o.product|e }}"
      data-qty="{{ o.quantity }}"
      data-datecreate="{{ o.datecreate|e }}"
      data-fengbian="{{ o.fengbian|e }}"
      data-wallpaper="{{ o.wallpaper|e }}"
      data-jobdesc="{{ o.jobdesc|e }}">
      <td>
        {% set done = o.progress[0] %}
        {% set total = o.progress[1] if o.progress[1] else 1 %}
        <div class="progress-bar">
          <div class="progress-fill" style="width: {{ (done/total)*100 }}%"></div>
        </div>
      </td>
      <td>{{ o.demand_date }}</td>
      <td>{{ o.delivery }}</td>
      <td>{{ o.manufacture_code }}</td>
      <td>{{ o.customer }}</td>
      <td>{{ o.product }}</td>
      <td>{{ o.quantity }}</td>
      <td>{{ o.datecreate }}</td>
      <td>{{ o.fengbian }}</td>
      <td>{{ o.wallpaper }}</td>
      <td>{{ o.jobdesc }}</td>
      <td id="groups-{{o.id}}">{{ o.active_groups }}</td>
      <td>
        {% if archived_page == False %}
          <button class="btn green" onclick="toggleDetails({{o.id}})">Expand</button>
          <button class="btn gray" onclick="openEditOrder({{ o.id }})">Edit</button>
          <button class="btn red" onclick="deleteOrder({{ o.id }})">Delete</button>
          <button class="btn gray" onclick="archiveOrder({{ o.id }})">Archive</button>
        {% else %}
          <button class="btn gray" onclick="restoreOrder({{ o.id }})">Restore</button>
          <button class="btn red" onclick="deleteOrder({{ o.id }})">Delete</button>
        {% endif %}
      </td>
    </tr>

    <tr>
      <td colspan="13" style="padding:0; border:0">
        <table style="width:100%; border-collapse:collapse">
          <tbody id="details-{{ o.id }}" style="display:none">
            <tr>
              <th>Progress</th>
              <th>組別</th>
              <th>數量</th>
              <th>工作內容</th>
              <th>已完成</th>
              <th>剩下</th>
              <th>Actions</th>
            </tr>
            {% for t in o.sub_tasks %}
            <tr id="task-{{ t.id }}" data-qty="{{ t.quantity }}" data-order="{{ o.id }}">
              <td>
                {% set ttot = t.quantity if t.quantity else 1 %}
                <div class="progress-bar">
                  <div class="progress-fill" style="width: {{ (t.completed / ttot) * 100 }}%"></div>
                </div>
                <div class="task-status {{ 'running' if t.running else '' }}">
                  <span class="dot"></span>
                  <span>
                    {{ 'Running' if t.running else 'Idle' }}
                    {% if t.running and t.started_at %}
                      <span style="opacity:.7">• since {{ t.started_at[:19].replace('T',' ') }}</span>
                    {% endif %}
                  </span>
                </div>
              </td>
              <td>{{ t.group }}</td>
              <td class="qty">{{ t.quantity }}</td>
              <td class="name">{{ t.task }}</td>
              <td>{{ t.quantity }}</td>
              <td>{{ t.task }}</td>
              <td><input type="number" id="done-{{ t.id }}" value="{{ t.completed }}" style="width:80px;text-align:center"></td>
              <td class="remaining">{{ t.remaining }}</td>
              <td>
                <button type="button" class="btn gray" onclick="startTask({{ t.id }})" {{ 'disabled' if t.running else '' }}>Start</button>
                <button type="button" class="btn" onclick="updateTask({{ t.id }}, {{ o.id }})">Update</button>
                <button class="btn" onclick="showHistory({{ t.id }}, {{ o.id }})">History</button>
                <button class="btn" onclick="editTask({{ t.id }}, {{ o.id }}, '{{ t.group }}', '{{ t.task }}', {{ t.quantity }})">Edit</button>
                <button class="btn red" onclick="deleteTask({{ t.id }}, {{ o.id }})">Delete</button>
                <button type="button" class="btn gray" onclick="stopTask({{ t.id }})" {{ '' if t.running else 'disabled' }}>Stop</button>
              </td>
            </tr>
            {% endfor %}
            <tr>
              <td colspan="7"><button class="btn" onclick="openTaskModal({{ o.id }})">+ Add Task</button></td>
            </tr>
          </tbody>
        </table>
      </td>
    </tr>
    {% if not loop.last %}
    <tr class="order-gap"><td colspan="13" aria-hidden="true"></td></tr>
    {% endif %}
    {% endfor %}
  <!-- Import Modal -->
  <button class="btn" onclick="location.href='/export/orders.xlsx'">Export Excel</button>
  <button class="btn gray" onclick="openModal('modal-import')">Import Excel</button>
  <div id="modal-import" class="modal" onclick="if(event.target===this) closeModal('modal-import')">
    <div class="panel">
      <h3 style="margin:0">Import Orders (Excel .xlsx)</h3>
      <input type="file" id="import-file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="margin-top:10px">
      <div style="margin-top:8px">
        <input id="import-sheet" placeholder="工作表名稱 (例如: 生產中門框)" value="生產中門框" />
      </div>
      <div style="margin-top:12px"><button class="btn" onclick="submitImport()">Upload & Import</button></div>
    </div>
  </div>
  <div id="modal-bulk" class="modal" onclick="if(event.target===this) closeModal('modal-bulk')">
    <div class="panel">
      <h3 style="margin:0">Bulk Add Tasks</h3>
      <input type="hidden" id="bulk-order-id">
      <div class="station-planner" id="bulk-planner"></div>
      <button class="btn gray" onclick="addPlannedStationTo('bulk-planner')">+ 新增站</button>
      <div style="margin-top:12px"><button class="btn" onclick="submitBulkTasks()">Save</button></div>
    </div>
  </div>


  <!-- Add Order Modal -->
  <div id="modal-order" class="modal" onclick="if(event.target===this) closeModal('modal-order')">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Add Order</h3>
        <button class="btn" onclick="closeModal('modal-order')">Close</button>
      </div>
      <div style="margin-top:10px"><input id="m-demand" placeholder="客戶交期 YYYY/MM/DD"></div>
      <div style="margin-top:8px"><input id="m-delivery" placeholder="預計出貨 YYYY/MM/DD"></div>
      <div style="margin-top:8px"><input id="m-code" placeholder="製令號碼"></div>
      <div style="margin-top:8px"><input id="m-customer" placeholder="專案名稱"></div>
      <div style="margin-top:8px"><input id="m-product" placeholder="產品名稱"></div>
      <div style="margin-top:8px"><input id="m-qty" type="number" placeholder="數量"></div>
      <div style="margin-top:8px"><input id="m-datecreate" placeholder="派單日 YYYY/MM/DD"></div>
      <div style="margin-top:8px"><input id="m-fengbian" placeholder="封邊"></div>
      <div style="margin-top:8px"><input id="m-wallpaper" placeholder="面飾"></div>
      <div style="margin-top:8px"><input id="m-jobdesc" type="text" placeholder="備註"></div>
      <div style="margin-top:8px"><b>計劃流程（初始站）</b></div>
      <div class="station-planner" id="station-planner"></div>
      <button class="btn gray" onclick="addPlannedStation()">+ 新增站</button>
      <div style="margin-top:12px"><button class="btn" onclick="submitOrder()">Save</button></div>
    </div>
  </div>

<template id="station-template">
  <div class="row">
    <select class="station-select">
      <option value="">-- 選擇組別 --</option>
      <option value="原物料裁切組">原物料裁切組</option>
      <option value="框架組">框架組</option>
      <option value="膠合組">膠合組</option>
      <option value="門裁切組">門裁切組</option>
      <option value="封邊組">封邊組</option>
      <option value="整修組">整修組</option>
      <option value="噴漆組">噴漆組</option>
      <option value="CNC組">CNC組</option>
      <option value="包裝組">包裝組</option>
      <option value="自動缐組">自動缐組</option>
      <option value="__custom__">自訂組別…</option>
    </select>
    <input type="text" class="custom-station-input" placeholder="輸入自訂組別名稱" style="display:none">
    <input type="text" class="task-name-input" placeholder="工作內容"/>
    <button class="btn red" onclick="this.parentNode.remove()">X</button>
  </div>
</template>

  <div id="modal-edit-order" class="modal" onclick="if(event.target===this) closeModal('modal-edit-order')">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Edit Order</h3>
        <button class="btn" onclick="closeModal('modal-edit-order')">Close</button>
      </div>

      <input type="hidden" id="e-id" />
      <div style="margin-top:10px"><input id="e-demand" placeholder="客戶交期 YYYY/MM/DD"></div>
      <div style="margin-top:8px"><input id="e-delivery" placeholder="預計出貨 YYYY/MM/DD"></div>
      <div style="margin-top:8px"><input id="e-code" placeholder="製令號碼"></div>
      <div style="margin-top:8px"><input id="e-customer" placeholder="專案名稱"></div>
      <div style="margin-top:8px"><input id="e-product" placeholder="產品名稱"></div>
      <div style="margin-top:8px"><input id="e-qty" type="number" placeholder="數量"></div>
      <div style="margin-top:8px"><input id="e-datecreate" placeholder="派單日 YYYY/MM/DD"></div>
      <div style="margin-top:8px"><input id="e-fengbian" placeholder="封邊"></div>
      <div style="margin-top:8px"><input id="e-wallpaper" placeholder="面飾"></div>
      <div style="margin-top:8px"><input id="e-jobdesc" placeholder="作業內容"></div>

      <div style="margin-top:12px"><button class="btn" onclick="submitEditOrder()">Save</button></div>
    </div>
  </div>


  <!-- Add Task Modal -->
  <div id="modal-task" class="modal" onclick="if(event.target===this) closeModal('modal-task')">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Add Task</h3>
        <button class="btn" onclick="closeModal('modal-task')">Close</button>
      </div>
      <input type="hidden" id="t-order-id" />
      <div style="margin-top:10px; display:flex; gap:12px; align-items:center">
        <select id="t-group-select" class="station-select" style="min-width:180px">
          <option value="">-- 選擇組別 --</option>
          <option value="原物料裁切組">原物料裁切組</option>
          <option value="框架組">框架組</option>
          <option value="膠合組">膠合組</option>
          <option value="門裁切組">門裁切組</option>
          <option value="封邊組">封邊組</option>
          <option value="整修組">整修組</option>
          <option value="噴漆組">噴漆組</option>
          <option value="CNC組">CNC組</option>
          <option value="包裝組">包裝組</option>
          <option value="自動缐組">自動缐組</option>
          <option value="__custom__">自訂組別…</option>
        </select>
        <input type="text" id="t-group-custom" class="custom-station-input"
              placeholder="輸入自訂組別名稱" style="display:none; width:160px">
      </div>
      <div style="margin-top:8px"><input id="t-task" placeholder="工作內容"></div>
      <div style="margin-top:8px"><input id="t-qty" type="number" placeholder="數量"></div>
      <div style="margin-top:12px"><button class="btn" onclick="submitTask()">Save</button></div>
    </div>
  </div>

  <!-- Task History Modal -->
  <div id="modal-history" class="modal" onclick="if(event.target===this) closeModal('modal-history')">
  <div class="panel" style="max-height:70vh;overflow:auto">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Task History</h3>
      <button class="btn" onclick="closeModal('modal-history')">Close</button>
    </div>
    <div id="history-content" style="margin-top:12px">
      <p>Loading...</p>
    </div>
  </div>
</div>

  <!-- Edit Task Modal -->
<div id="modal-edit-task" class="modal" onclick="if(event.target===this) closeModal('modal-edit-task')">
  <div class="panel">
    <h3>Edit Task</h3>
    <input type="hidden" id="edit-task-id" />
    <input type="hidden" id="edit-order-id" />
    <div style="margin-top:8px; display:flex; gap:12px; align-items:center">
      <select id="edit-group-select" class="station-select" style="min-width:180px">
        <option value="">-- 選擇組別 --</option>
        <option value="原物料裁切組">原物料裁切組</option>
        <option value="框架組">框架組</option>
        <option value="膠合組">膠合組</option>
        <option value="門裁切組">門裁切組</option>
        <option value="封邊組">封邊組</option>
        <option value="整修組">整修組</option>
        <option value="噴漆組">噴漆組</option>
        <option value="CNC組">CNC組</option>
        <option value="包裝組">包裝組</option>
        <option value="自動缐組">自動缐組</option>
        <option value="__custom__">自訂組別…</option>
      </select>
      <input type="text" id="edit-group-custom" class="custom-station-input"
            placeholder="輸入自訂組別名稱" style="display:none; width:160px">
    </div>
    <div style="margin-top:8px"><input id="edit-name" placeholder="工作內容"></div>
    <div style="margin-top:8px"><input id="edit-qty" type="number" placeholder="數量"></div>
    <div style="margin-top:12px"><button class="btn" onclick="submitEditTask()">Save</button></div>
  </div>
</div>

</body>
</html>
