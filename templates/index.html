<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Order Status (Starter)</title>
  <style>
    body{font-family:Arial, sans-serif;background:#ededf0;margin:20px}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:6px;overflow:hidden}
    th,td{border:1px solid #ddd;padding:8px;text-align:center}
    th{background:#007bff;color:#fff}
    .progress-bar{width:100%;height:10px;background:#e0e0e0;border-radius:6px;overflow:hidden}
    .progress-fill{height:100%;background:#28a745;transition:width .3s}
    .btn{padding:6px 10px;border:0;border-radius:4px;color:#fff;background:#007bff;cursor:pointer}
    .btn.green{background:#28a745}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:1000}
    .panel{width:360px;margin:8% auto;background:#fff;border-radius:8px;padding:16px 20px}
    input,select{padding:6px;border:1px solid #ccc;border-radius:4px;width:100%}
    .btn.red { background: #dc3545; }
  </style>
  <script defer src="/static/main.js"></script>
</head>
<body>
  <h1>Live Order Status (Starter)</h1>
  <button class="btn" onclick="openModal('modal-order')">Add Order</button>
  <p>Today {{ today_date }}</p>

  <table>
    <tr>
      <th>Progress</th>
      <th>客戶交期</th>
      <th>預計出貨</th>
      <th>製令號碼</th>
      <th>專案名稱</th>
      <th>產品名稱</th>
      <th>數量</th>
      <th>派單日</th>
      <th>封邊</th>
      <th>面飾</th>
      <th>作業內容</th>
      <th>現場組別</th>
      <th>Actions</th>
    </tr>
    {% for o in orders %}
    <tr id="order-{{o.id}}">
      <td>
        {% set done = o.progress[0] %}
        {% set total = o.progress[1] if o.progress[1] else 1 %}
        <div class="progress-bar">
          <div class="progress-fill" style="width: {{ (done/total)*100 }}%"></div>
        </div>
      </td>
      <td>{{ o.demand_date }}</td>
      <td>{{ o.delivery }}</td>
      <td>{{ o.manufacture_code }}</td>
      <td>{{ o.customer }}</td>
      <td>{{ o.product }}</td>
      <td>{{ o.quantity }}</td>
      <td>{{ o.datecreate }}</td>
      <td>{{ o.fengbian }}</td>
      <td>{{ o.wallpaper }}</td>
      <td>{{ o.jobdesc }}</td>
      <td id="groups-{{o.id}}">{{ o.active_groups }}</td>
      <td>
        <button class="btn green" onclick="toggleDetails({{o.id}})">Expand</button>
        <button class="btn red" onclick="deleteOrder({{ o.id }})">Delete</button>
      </td>
    </tr>

    <tbody id="details-{{o.id}}" style="display:none">
      <tr>
        <th>Progress</th><th>組別</th><th>數量</th><th>工作內容</th>
        <th>已完成</th><th>剩下</th><th>Actions</th>
      </tr>
      {% for t in o.sub_tasks %}
      <tr id="task-{{t.id}}">
        <td>
          {% set ttot = t.quantity if t.quantity else 1 %}
          <div class="progress-bar"><div class="progress-fill" style="width: {{ (t.completed/ttot)*100 }}%"></div></div>
        </td>
        <td>{{ t.group }}</td>
        <td>{{ t.quantity }}</td>
        <td>{{ t.task }}</td>
        <td><input type="number" id="done-{{ t.id }}" value="{{ t.completed }}" style="width:80px;text-align:center"></td>
        <td>{{ t.remaining }}</td>
        <td>
          <button class="btn" onclick="updateTask({{ t.id }}, {{ o.id }})">Update</button>
          <button class="btn" onclick="showHistory({{ t.id }}, {{ o.id }})">History</button>
          <button class="btn" onclick="editTask({{ t.id }}, {{ o.id }}, '{{ t.group }}', '{{ t.task }}', {{ t.quantity }})">Edit</button>
          <button class="btn red" onclick="deleteTask({{ t.id }}, {{ o.id }})">Delete</button>
        </td>
      </tr>
      {% endfor %}
      <tr><td colspan="7"><button class="btn" onclick="openTaskModal({{o.id}})">+ Add Task</button></td></tr>
    </tbody>
    {% endfor %}
  </table>

  <!-- Add Order Modal -->
  <div id="modal-order" class="modal" onclick="if(event.target===this) closeModal('modal-order')">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Add Order</h3>
        <button class="btn" onclick="closeModal('modal-order')">Close</button>
      </div>
      <div style="margin-top:10px"><input id="m-demand" placeholder="客戶交期 YYYY/MM/DD"></div>
      <div style="margin-top:8px"><input id="m-delivery" placeholder="預計出貨 YYYY/MM/DD"></div>
      <div style="margin-top:8px"><input id="m-code" placeholder="製令號碼"></div>
      <div style="margin-top:8px"><input id="m-customer" placeholder="專案名稱"></div>
      <div style="margin-top:8px"><input id="m-product" placeholder="產品名稱"></div>
      <div style="margin-top:8px"><input id="m-qty" type="number" placeholder="數量"></div>
      <div style="margin-top:8px"><input id="m-datecreate" placeholder="派單日 YYYY/MM/DD"></div>
      <div style="margin-top:8px"><input id="m-fengbian" placeholder="封邊"></div>
      <div style="margin-top:8px"><input id="m-wallpaper" placeholder="面飾"></div>
      <div style="margin-top:8px"><input id="m-jobdesc" placeholder="作業內容"></div>
      <div style="margin-top:12px"><button class="btn" onclick="submitOrder()">Save</button></div>
    </div>
  </div>

  <!-- Add Task Modal -->
  <div id="modal-task" class="modal" onclick="if(event.target===this) closeModal('modal-task')">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Add Task</h3>
        <button class="btn" onclick="closeModal('modal-task')">Close</button>
      </div>
      <input type="hidden" id="t-order-id" />
      <div style="margin-top:10px"><input id="t-group" placeholder="組別"></div>
      <div style="margin-top:8px"><input id="t-task" placeholder="工作內容"></div>
      <div style="margin-top:8px"><input id="t-qty" type="number" placeholder="數量"></div>
      <div style="margin-top:12px"><button class="btn" onclick="submitTask()">Save</button></div>
    </div>
  </div>

  <!-- Task History Modal -->
  <div id="modal-history" class="modal" onclick="if(event.target===this) closeModal('modal-history')">
  <div class="panel" style="max-height:70vh;overflow:auto">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Task History</h3>
      <button class="btn" onclick="closeModal('modal-history')">Close</button>
    </div>
    <div id="history-content" style="margin-top:12px">
      <p>Loading...</p>
    </div>
  </div>
</div>

  <!-- Edit Task Modal -->
<div id="modal-edit-task" class="modal" onclick="if(event.target===this) closeModal('modal-edit-task')">
  <div class="panel">
    <h3>Edit Task</h3>
    <input type="hidden" id="edit-task-id" />
    <input type="hidden" id="edit-order-id" />
    <div style="margin-top:8px"><input id="edit-group" placeholder="組別"></div>
    <div style="margin-top:8px"><input id="edit-name" placeholder="工作內容"></div>
    <div style="margin-top:8px"><input id="edit-qty" type="number" placeholder="數量"></div>
    <div style="margin-top:12px"><button class="btn" onclick="submitEditTask()">Save</button></div>
  </div>
</div>

</body>
</html>
