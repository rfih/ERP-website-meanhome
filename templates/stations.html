<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Station Progress</title>
  <link rel="stylesheet" href="/static/common.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='stations-print.css') }}" media="print">
  <script>
    function updateTask(taskId, orderId) {
      const inputEl = document.getElementById(`task-completed-${taskId}-${orderId}`);
      const newCompleted = parseInt(inputEl.value);
    
      const noteInput = document.getElementById(`task-note-${taskId}-${orderId}`);
      const note = noteInput ? noteInput.value : "";
    
      fetch("/update_task", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ task_id: taskId, order_id: orderId, completed: newCompleted, note: note })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) return alert("Update error.");
        const fill = document.querySelector(`#task-progress-${taskId}-${orderId} .progress-fill`);
        if (fill) fill.style.width = `${(data.task.completed / data.task.quantity) * 100}%`;
        document.getElementById(`task-remaining-${taskId}-${orderId}`).textContent = data.task.quantity - data.task.completed;
        const lastUpdateEl = document.getElementById(`last-update-${taskId}-${orderId}`);
        if (lastUpdateEl) {
          const date = data.task.timestamp.split(" ")[0];
          lastUpdateEl.textContent = `${date} (+${data.task.delta})`;
        }
      })
      .catch(err => console.error("Update failed:", err));
    }
    
    function deleteTask(taskId, orderId) {
      if (!confirm("Are you sure you want to delete this task?")) return;
    
      fetch("/delete_task", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ task_id: taskId, order_id: orderId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) location.reload();
        else alert("Delete failed.");
      })
      .catch(err => console.error("Delete error:", err));
    }

    function showTaskHistory(taskId, orderId) {
      fetch(`/task_history?order_id=${orderId}&task_id=${taskId}`)
        .then(res => res.json())
        .then(data => {
          const list = document.getElementById("historyContent");
          list.innerHTML = "";
    
          if (!data.history || data.history.length === 0) {
            list.innerHTML = "<li>No updates yet.</li>";
          } else {
            // Group by date like index.html
            const grouped = {};
            data.history.forEach(item => {
              const date = item.timestamp.split(" ")[0];
              if (!grouped[date]) grouped[date] = [];
              grouped[date].push(item);
            });
    
            for (const date in grouped) {
              const dateItem = document.createElement("li");
              dateItem.innerHTML = `<strong>${date}</strong>`;
              list.appendChild(dateItem);
    
              grouped[date].forEach(entry => {
                const li = document.createElement("li");
                li.textContent = `${entry.timestamp} → +${entry.delta}`;
                list.appendChild(li);
              });
            }
          }
    
          document.getElementById("historyModal").style.display = "block";
        });
    }
    
    function closeModal(id) {
      document.getElementById(id).style.display = "none";
    }
    
    let currentSortCol = null;
    let sortAsc = true;
    let originalStationRows = [];

    window.addEventListener("DOMContentLoaded", () => {
      const tbody = document.querySelector("table tbody");
      originalStationRows = Array.from(tbody.rows);
    });

    function sortStationTable(colIndex) {
      const table = document.querySelector("table");
      const tbody = table.tBodies[0];
      const rows = Array.from(tbody.rows);

      rows.sort((a, b) => {
        const getText = (row) => row.cells[colIndex]?.innerText.trim();
        const valA = getText(a);
        const valB = getText(b);

        if (colIndex === 0) {
          const progress = row => parseFloat(row.querySelector(".progress-fill")?.style.width || 0);
          return (progress(a) - progress(b)) * (sortAsc ? 1 : -1);
        }

        if (colIndex === 1) {
          const dateA = new Date(valA.replaceAll('/', '-'));
          const dateB = new Date(valB.replaceAll('/', '-'));
          return (dateA - dateB) * (sortAsc ? 1 : -1);
        }

        const aNum = parseFloat(valA);
        const bNum = parseFloat(valB);
        const isNumber = !isNaN(aNum) && !isNaN(bNum);

        return isNumber
          ? (aNum - bNum) * (sortAsc ? 1 : -1)
          : valA.localeCompare(valB, 'zh') * (sortAsc ? 1 : -1);
      });

      tbody.innerHTML = "";
      rows.forEach(row => tbody.appendChild(row));

      sortAsc = currentSortCol === colIndex ? !sortAsc : true;
      currentSortCol = colIndex;

      updateStationSortIcons(colIndex);
    }

    function updateStationSortIcons(activeCol) {
      const headers = document.querySelectorAll("table thead th");
      headers.forEach((th, i) => {
        const label = th.innerText.replace(/[\s\u2191\u2193]/g, '').trim();
        if (i === activeCol) {
          th.innerHTML = `${label} ${sortAsc ? '↑' : '↓'}`;
        } else {
          th.innerHTML = `${label} ↑↓`;
        }
      });
    }

    function resetStationSort() {
      const tbody = document.querySelector("table tbody");
      tbody.innerHTML = "";
      originalStationRows.forEach(row => tbody.appendChild(row.cloneNode(true)));
      updateStationSortIcons(null);
      currentSortCol = null;
    }
    
    function printPage() {
      const buttons = document.querySelectorAll("button, nav, select");
      buttons.forEach(btn => btn.style.display = "none");
  
      window.print();
  
      setTimeout(() => {
        buttons.forEach(btn => btn.style.display = "");
      }, 1000);
    }
    
  </script>
</head>
<body class="stations-page sb-collapsed">
  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <div class="brand">Search</div>

      <!-- Search form (GET) -->
      <form method="get" action="{{ '/archived' if archived_page else '/' }}" class="sbm">
        <input type="text" name="q" id= "search-q" value="{{ qtext or '' }}"
              placeholder="搜尋：">

        <select name="dfield">
          <option value="any"        {{ 'selected' if (dfield or 'any')=='any' }}>全部日期欄位</option>
          <option value="demand"     {{ 'selected' if dfield=='demand' }}>客戶交期</option>
          <option value="delivery"   {{ 'selected' if dfield=='delivery' }}>預計出貨</option>
          <option value="datecreate" {{ 'selected' if dfield=='datecreate' }}>派單日</option>
        </select>

        <div class="row">
          <input type="date" name="dfrom" value="{{ dfrom or '' }}">
          <input type="date" name="dto"   value="{{ dto or '' }}">
        </div>

        <div class="row">
          <button class="btn" type="submit">Search</button>
          {% if qtext or dfrom or dto %}
            <a class="btn gray" href="{{ '/archived' if archived_page else '/' }}">Clear</a>
          {% endif %}
        </div>

        <div class="caption">共 {{ orders|length }} 筆{% if qtext or dfrom or dto %}（篩選中）{% endif %}</div>

        <hr style="margin:12px 0">

        <div class="nav" style="margin-top:6px">
          <!-- General stations page -->
          <a href="/" class="btn full">Main</a>
          <hr style="margin:12px 0">
          <a href="/stations/today" class="btn full">Stations — Today</a>
          <hr style="margin:12px 0">
          <a href="/stations/backlog" class="btn full gray" style="margin-top:6px">Stations — Backlog


          <!-- Quick link for *today's* plan (uses your today_date; converts 2025/08/20 -> 2025-08-20) -->

          </a>
        </div>
      </form>
    </aside>
    <main class="content">
      <div class="page-header">
        <div class="left">
          <button class="btn hamburger" onclick="toggleSidebar()">☰ Menu</button>
          <h2 style="margin:0">
            Station Progress — {{ 'Today' if page_mode == 'today' else 'Backlog' }}
          </h2>
          <p class="muted" style="margin:4px 0 0">
            {% if page_mode == 'today' %}Date: {{ day }}{% else %}All open tasks{% endif %}
          </p>
        </div>
        <div class="right">
          <span class="today">Today: {{ today_date }}</span>
        </div>
      </div>
      {% if page_mode == 'backlog' %}
        <div class="toolbar">
          <strong>Sort:</strong>
          <a href="?group={{ selected_group }}&sort=due" class="{{ 'active' if sort=='due' else '' }}">Effective due</a>
          <a href="?group={{ selected_group }}&sort=fifo" class="{{ 'active' if sort=='fifo' else '' }}">FIFO</a>
        </div>
      {% elif page_mode == 'today' %}
        <div class="toolbar">
          <strong>Sort:</strong>
          <a href="?group={{ selected_group }}&rolling={{ 1 if rolling else 0 }}&sort=seq" class="{{ 'active' if sort=='seq' else '' }}">By plan order</a>
          <a href="?group={{ selected_group }}&rolling={{ 1 if rolling else 0 }}&sort=due" class="{{ 'active' if sort=='due' else '' }}">Effective due</a>
        </div>
      {% endif %}
      <div class="toolbar">
        <div class="group">
          {% set form_action = '/stations/today' if page_mode == 'today' else '/stations/backlog' %}
          <form method="get" action="{{ form_action }}" style="display:flex; align-items:center; gap:8px; margin:0">
            <label>選擇組別:</label>
            {% set form_action = '/stations/today' if page_mode == 'today' else '/stations/backlog' %}
            <select name="group" onchange="this.form.submit()">
              {% for name in station_list %}
                <option value="{{ name }}" {% if name == selected_group %}selected{% endif %}>{{ name }}</option>
              {% endfor %}
            </select>
            {% if page_mode == 'today' %}
              <input id="plan-date" type="date" name="date" value="{{ day }}" onchange="this.form.submit()">
            {% endif %}
          </form>
          {% if page_mode == 'backlog' %}
            <div class="group">
              <button type="button" class="btn" onclick="planSelected()">加入今日計畫</button>
            </div>
          {% endif %}
        </div>
        <div class="group">
          <button type="button" onclick="resetStationSort()">Clear Sort</button>
          <button type="button" onclick="printPage()">🖨️ Print This Station</button>
        </div>
      </div>
      
      <!-- PRINT HEADER (shows on paper only) -->
      <div class="print-only sp-print-header">
        <table class="sp-ph">
          <tr>
            <td class="lab">生產排程：</td>
            <td class="val">{{ request.args.get('group','') or '________' }}</td>
            <td class="lab mid">排程日：</td>
            <td class="val">{{ request.args.get('date','') or today_date }}</td>
            <td class="lab mid">人員 Pekerja：</td>
            <td class="val blankline">________________</td>
          </tr>
        </table>
      </div>
      <table class="print-table print-only">
        <thead>
          <tr>
            <th>客戶交期<br><span class="print-label">Tanggal Ekspektasi Pengiriman oleh Tamu</span></th>
            <th>預計出貨<br><span class="print-label">Tanggal Barang Dapat Dikirim</span></th>
            <th>製令號碼<br><span class="print-label">Nomor Pesanan</span></th>
            <th>專案名稱<br><span class="print-label">Nama Proyek</span></th>
            <th>產品名稱<br><span class="print-label">Nama Produk</span></th>
            <th>製令數量<br><span class="print-label">Jumlah Pesanan</span></th>
            <th>作業內容<br><span class="print-label">Isi Pekerjaan</span></th>
            <th>注意事項<br><span class="print-label">Hal yang Perlu Diperhatikan</span></th>
            <th>計劃數量<br><span class="print-label">Jumlah Proyek</span></th>
            <th>良品數量<br><span class="print-label">Jumlah Produk Lolos</span></th>
            <th>不良品數量<br><span class="print-label">Jumlah Produk Tidak Lolos</span></th>
            <th>生產總時間(分)<br><span class="print-label">Total Waktu Produksi (dalam menit)</span></th>
          </tr>
        </thead>
        <tbody>
          {% for item in tasks %}
            {% set rem = (item.task.quantity or 0) - (item.task.completed or 0) %}
            <tr>
              <td>{{ item.order.demand_date|fmtdate or '—' }}</td>
              <td>{{ item.order.delivery|fmtdate or '—' }}</td>
              <td>{{ item.order.manufacture_code }}</td>
              <td>{{ item.order.customer }}</td>
              <td>{{ item.order.product }}</td>
              <td style="text-align:center">{{ item.task.quantity or 0 }}</td>
              <td>{{ item.task.task }}</td>
              <td class="pt-notes">{{ item.task.note or '' }}</td>
              <td style="text-align:center">{{ rem if rem > 0 else 0 }}</td>
              <td class="pt-center"></td>
              <td class="pt-center"></td>
              <td class="pt-center"></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <table class="screen-table">
        <thead>
          <tr>
            <th onclick="sortStationTable(0)">Progress ↑↓</th>
            <th onclick="sortStationTable(1)">客戶交期 ↑↓<span class="print-label"><br>Tanggal Ekspektasi Pengiriman oleh Tamu</span></th>
            <th onclick="sortStationTable(2)">預計出貨 ↑↓<span class="print-label"><br>Tanggal Barang Dapat Dikirim</span></th>
            <th>Effective due</th>
            <th onclick="sortStationTable(3)">製令號碼 ↑↓<span class="print-label"><br>Nomor Pesanan</span></th>
            <th onclick="sortStationTable(4)">專案名稱 ↑↓<span class="print-label"><br>Nama Proyek</span></th>
            <th onclick="sortStationTable(5)">產品名稱 ↑↓<span class="print-label"><br>Nama Produk</span></th>
            <th onclick="sortStationTable(6)">製令數量 ↑↓<span class="print-label"><br>Jumlah Pesanan</span></th>
            <th onclick="sortStationTable(7)">作業內容 ↑↓<span class="print-label"><br>Isi Pekerjaan</span></th>
            <th class="cell-notes">注意事項<br><span class="print-label">Hal yang Perlu Diperhatikan</span></th>
            <th onclick="sortStationTable(8)">已完成 ↑↓</th>
            <th onclick="sortStationTable(9)">剩下 ↑↓<span class="print-label"><br>Jumlah Proyek</span></th>
            <th onclick="sortStationTable(10)">最後更新 ↑↓</th>
            <th class="actions-col">Actions</th>
            {% if page_mode == 'backlog' %}
              <th style="width:28px; text-align:center">
                <input type="checkbox" id="chk-all" onclick="toggleAll(this)">
              </th>
            {% endif %}
            <th class="print-only">良品數量<span class="print-label"><br>Jumlah Produk Lolos</span></th>
            <th class="print-only">不良品數量<span class="print-label"><br>Jumlah Produk Tidak Lolos</span></th>
            <th class="print-only">生產總時間(分)<span class="print-label"><br>Total Waktu Produksi (dalam menit)</span></th>
          </tr>
        </thead>
        <tbody>
          {% for item in tasks %}
          {% set running = (item.task.start_time and not item.task.stop_time) %}
          <tr id="task-{{ item.task.id }}" class="{{ 'is-running' if running else '' }}"
              data-order-id="{{ item.order.id }}" data-qty="{{ item.task.quantity or 0 }}">
            <td>
              <div class="progress-bar">
                <div class="progress-fill {{ 'running' if running else '' }}"
                    style="width: {{ (item.task.completed / item.task.quantity) * 100 if item.task.quantity else 0 }}%"></div>
              </div>
              <div class="row-flash" id="rowflash-{{ item.task.id }}"></div>
            </td>
            <td>{{ item.order.demand_date|fmtdate or '—' }}</td>
            <td>{{ item.order.delivery|fmtdate or '—' }}</td>
            <td>
              {% if item.effective_due %}
                {{ item.effective_due|fmtdate }}
                <span class="pill muted">(from {{ item.effective_due_src }})</span>
              {% else %} — {% endif %}
            </td>
            <td>{{ item.order.manufacture_code }}</td>
            <td>{{ item.order.customer }}</td>
            <td>{{ item.order.product }}</td>
            <td data-role="qty">{{ item.task.quantity or 0 }}</td>
            <td>{{ item.task.task }}</td>
            <td>
              <textarea id="task-note-{{ item.task.id }}-{{ item.order.id }}" rows="2" style="width: 100%;" class="screen-only">{{ item.task.note or '' }}</textarea>
              <div class="print-note print-only">{{ item.task.note or '' }}</div>
            </td>
            <td>
              <input id="done-{{ item.task.id }}" type="number" min="0" value="{{ item.task.completed or 0 }}" style="width:80px">
            </td>
            <td class="remaining" id="task-remaining-{{ item.task.id }}-{{ item.order.id }}">
              {% set rem = (item.task.quantity or 0) - (item.task.completed or 0) %}
              {{ rem if rem > 0 else 0 }}
            </td>
            <td id="last-update-{{ item.task.id }}-{{ item.order.id }}">
              {% if item.task.history %}
                {# pick the last history row if it exists #}
                {% set last = item.task.history|last if item.task.history else None %}

                {% if last and last.timestamp %}
                  {% if last.timestamp is string %}
                    {{ last.timestamp.split(' ')[0] }}
                  {% else %}
                    {{ last.timestamp.strftime('%Y/%m/%d') }}
                  {% endif %}
                  {% if last.delta is not none %} (+{{ last.delta }}){% endif %}
                {% else %}
                  -
                {% endif %}
              {% else %}-{% endif %}
            </td>
            <td class="actions-col">
              <div class="task-status {{ 'running' if running else '' }}">
                <span class="dot"></span><span>{{ 'Running' if running else 'Idle' }}</span>
              </div>
              <div class="actions-group">
                <button class="btn" onclick="startTask({{ item.task.id }})" {{ 'disabled' if running else '' }}>Start</button>
                <button class="btn" onclick="updateTask({{ item.task.id }}, {{ item.order.id }})">Update</button>
                <button class="btn" onclick="stopTask({{ item.task.id }})"  {{ '' if running else 'disabled' }}>Stop</button>
                <button class="btn gray" onclick="showHistory({{ item.task.id }})">History</button>
                <button class="btn red" onclick="finishTask({{ item.task.id }})">Finish</button>
                <button class="btn red" onclick="deleteTask({{ item.task.id }}, {{ item.order.id }})">Delete</button>
                {% if page_mode == 'today' %}
                  <button class="btn gray" onclick="unplanOne({{ item.task.id }})">Remove</button>
                {% endif %}
                {% if page_mode == 'backlog' %}
                  <button class="btn outline" onclick="planOne({{ item.task.id }})">➕ Plan</button>
                  <button class="btn gray" onclick="setPlanDate(1)">明天</button>
                {% endif %}
              </div>
              {% set rem = (item.task.quantity or 0) - (item.task.completed or 0) %}
              <div class="muted" data-remaining>
                {% if item.last_update %}
                來自 {{ item.last_update.from_group or '—' }}
                · {{ (item.last_update.timestamp or '')[:16].replace('T', ' ') }}
                {% if item.last_update.delta is not none and item.last_update.delta != 0 %}
                  (+{{ item.last_update.delta }})
                {% endif %}
              {% else %}
                —
              {% endif %}
              </div>
            </td>
            {% if page_mode == 'backlog' %}
              <td style="text-align:center">
                <input type="checkbox" class="chk-task" value="{{ item.task.id }}">
              </td>
            {% endif %}
            <td class="print-only"></td>
            <td class="print-only"></td>
            <td class="print-only"></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </main>
  </div>

<!-- History overlay (separate from sidebar overlay) -->
<div id="overlay-history" class="modal-overlay" onclick="closeHistory()"></div>

<!-- Single History modal -->
<div id="modal-history" class="modal" role="dialog" aria-modal="true" aria-labelledby="hist-title">
  <div class="m-header" id="hist-title">Task History</div>
  <div class="m-body">
    <div id="history-content">Loading…</div>
  </div>
  <div class="m-footer">
    <button class="btn gray" type="button" onclick="closeHistory()">Close</button>
  </div>
</div>


<script src="/static/main.js?v=3" defer></script>
</body>
</html>
